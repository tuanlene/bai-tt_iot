<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <title>Dashboard</title>
</head>
<body>
    <!-- SIDEBAR -->
    <section id="sidebar">
        <a href="#" class="brand">
            <img src="img/anhtruong.png" width="45" height="45">
            <span class="text">SMART IOT</span>
        </a>
        <ul class="side-menu top">
            <li class="active">
                <a href="index.html">
                    <i class='bx bxs-dashboard'></i>
                    <span class="text">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="phantich.html">
                    <i class='bx bxs-bar-chart-alt-2'></i>
                    <span class="text">Analytics</span>
                </a>
            </li>
            <li>
                <a href="thanhvien.html">
                    <i class='bx bxs-group'></i>
                    <span class="text">Team</span>
                </a>
            </li>
        </ul>
        <ul class="side-menu">
            <li>
                <a href="setting.html">
                    <i class='bx bxs-cog'></i>
                    <span class="text">Settings</span>
                </a>
            </li>
        </ul>
    </section>
    <!-- SIDEBAR -->

    <!-- CONTENT -->
    <section id="content">
        <!-- NAVBAR -->
        <nav>
            <i class='bx bx-menu'></i>
            <div id="real-time-clock" class="real-time-clock"></div>
            <form action="#">
                <div class="form-input">
                    <button type="submit"></button>
                </div>
            </form>
            <input type="checkbox" id="switch-mode" hidden>
            <label for="switch-mode" class="switch-mode"></label>
            <a href="#" class="notification"></a>
        </nav>
        <!-- NAVBAR -->

        <!-- MAIN -->
        <main>
            <div class="head-title">
                <div class="left">
                    <h1>SMART IOT</h1>
                    <h3>Dashboard</h3>
                </div>
            </div>

            <ul class="box-info">
                <li>
                    <i class='bx bx bxs-hot'></i>
                    <span class="text">
                        <h3>Khí gas</h3>
                        <p><span id="Khigas">--</span> 
                    </span>
                </li>
                <li>
                    <i class='bx bxs-thermometer'></i>
                    <span class="text">
                        <h3>Nhiệt độ</h3>
                        <p><span id="nhietdo">--</span>
                    </span>
                </li>
                <li>
                    <i class='bx bxs-droplet'></i>
                    <span class="text">
                        <h3>Độ ẩm</h3>
                        <p><span id="doam">--</span>
                    </span>
                </li>
            </ul>

            <div class="table-data">
                <div class="order">
                    <div class="head">
                        <h3>Bảng dữ liệu</h3>
                    </div>
                    <div class="data-container">
                        <h2>Nhiệt độ: <span id="nhietdoDisplay">--</span>°C | Độ ẩm: <span id="doamDisplay">--</span>% | Khí gas: <span id="khigasDisplay">--</span> ppm</h2>
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Nhiệt Độ (°C)</th>
                                    <th>Độ Ẩm (%)</th>
                                    <th>Khí gas (ppm)</th>
                                    <th>Thời Gian</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dữ liệu sẽ tự động cập nhật -->
                            </tbody>
                        </table>
                        <div class="btn_trang2">
                            <button id="downloadPDF" class="btn waves-effect waves-light">Tải PDF</button>
                        </div>
                        <div class="clear_storage">
                            <button id="CLEAR_STORAGE" class="btn waves-effect waves-light">CLEAR</button>
                        </div>                        
                    </div>
                </div>

                <div class="todo">
                    <div class="container">
                        <div class="square-box">
                            <div class="image-container">
                            <div class="control-container">
                                <img id="buzzer" src="img/bell.png" class="lamp" alt="Còi">
                                <img id="door" src="img/cua_dong.png" class="lamp" alt="Cửa">
                                <img id="fan" src="img/fan_off.png" class="lamp" alt="Quạt">
                            </div>
                        </div>
                    </div>
                        <div class="bottom">
                            <button type="button" id="btn1" class="btn waves-effect waves-lights">On_1</button>
                            <button type="button" id="btn2" class="btn waves-effect waves-lights">Off_1</button>
                            <button type="button" id="btn3" class="btn waves-effect waves-lights">On_2</button>
                            <button type="button" id="btn4" class="btn waves-effect waves-lights">Off_2</button>
                            <button type="button" id="btn5" class="btn waves-effect waves-lights">On_3</button>
                            <button type="button" id="btn6" class="btn waves-effect waves-lights">Off_3</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <!-- MAIN -->
    </section>
    <!-- CONTENT -->
    <script src="script.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-analytics.js"></script>
    <div class="bot">
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyClayDd1n7OcCkqZ6iOwdtD_m7OLRCnPDM",
            authDomain: "stupid-city.firebaseapp.com",
            databaseURL: "https://stupid-city-default-rtdb.firebaseio.com",
            projectId: "stupid-city",
            storageBucket: "stupid-city.firebasestorage.app",
            messagingSenderId: "238299841414",
            appId: "1:238299841414:web:9c4e1dcc3f1e9ab0952207",
            measurementId: "G-C2T6EV0XTV"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let latestTemp = null;
        let dataList = JSON.parse(localStorage.getItem("dataList")) || [];

        function getCurrentTime() {
            let time = new Date();
            let gio = String(time.getHours()).padStart(2, '0');
            let phut = String(time.getMinutes()).padStart(2, '0');
            let giay = String(time.getSeconds()).padStart(2, '0');
            return `${gio}:${phut}:${giay}`;
        }

        function getFirebaseData() {
            const tempRef = database.ref("/sensor/temperature");
            const humiRef = database.ref("/sensor/humidity");
            const gasRef = database.ref("/sensor/gas");  
        
            // Lấy nhiệt độ từ Firebase
            tempRef.on("value", (snapshot) => {
                let nhietdo = snapshot.val();
                if (nhietdo !== null) {
                    document.getElementById("nhietdo").innerText = nhietdo + " °C";
                    document.getElementById("nhietdoDisplay").innerText = nhietdo ;
                } else {
                    document.getElementById("nhietdo").innerText = "No Data";
                }
            });
        
            // Lấy độ ẩm từ Firebase
            humiRef.on("value", (snapshot) => {
                let doam = snapshot.val();
                if (doam !== null) {
                    document.getElementById("doam").innerText = doam + " %";
                    document.getElementById("doamDisplay").innerText = doam ;
                } else {
                    document.getElementById("doam").innerText = "No Data";
                }
            });
        
            // Lấy khí gas từ Firebase
            gasRef.on("value", (snapshot) => {
                let gas = snapshot.val();
                if (gas !== null) {
                    document.getElementById("Khigas").innerText = gas + "  ppm";
                    document.getElementById("khigasDisplay").innerText = gas ;
                } else {
                    document.getElementById("Khigas").innerText = "No Data";
                }
            });
        }
        
        function saveDataWithSensors() {
            Promise.all([
                database.ref("/sensor/humidity").once("value"),
                database.ref("/sensor/temperature").once("value"),
                database.ref("/sensor/gas").once("value"),
            ]).then(([humiSnapshot, tempSnapshot, gasSnapshot]) => {
                let doam = humiSnapshot.val();
                let nhietdo = tempSnapshot.val();
                let khigas = gasSnapshot.val();
                addRow(nhietdo, doam, khigas);
            });
        }
        getFirebaseData();
        function loadData() {
            let table = document.getElementById("dataTable").getElementsByTagName('tbody')[0];
            table.innerHTML = "";

            dataList.forEach((data, index) => {
                let newRow = table.insertRow();
                let cell1 = newRow.insertCell(0);
                let cell2 = newRow.insertCell(1);
                let cell3 = newRow.insertCell(2);
                let cell4 = newRow.insertCell(3);
                let cell5 = newRow.insertCell(4);

                cell1.innerHTML = index + 1;
                cell2.innerHTML = data.nhietdo;
                cell3.innerHTML = data.doam;
                cell4.innerHTML = data.khigas;
                cell5.innerHTML = data.time;
            });
        }
        function addRow(nhietdo, doam, khigas) {
            let table = document.getElementById("dataTable").getElementsByTagName('tbody')[0];
            let currentTime = getCurrentTime();

            dataList.push({ nhietdo, doam, khigas, time: currentTime });

            if (dataList.length > 20) {
                dataList.shift();
            }

            localStorage.setItem("dataList", JSON.stringify(dataList));
            loadData();
        }
        loadData();
    </script>
    <script>
        document.getElementById("downloadPDF").addEventListener("click", function () {
            let element = document.querySelector(".data-container");
            html2pdf()
                .set({
                    margin: 10,
                    filename: 'SMART_IOT.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                })
                .from(element)
                .save();
        });

        document.getElementById("CLEAR_STORAGE").addEventListener("click", function () {
            dataList = [];
            localStorage.removeItem("dataList");
            loadData();
        });

        const alertSound = new Audio("mp3/coibaodong.mp3");

        function checkAlert() {
            const alertState = localStorage.getItem("tempAlarmE");
            if (alertState === "on") {
                if (alertSound.paused || alertSound.ended) {
                    alertSound.currentTime = 0;
                    alertSound.play();
                }
            } else {
                alertSound.pause();
                alertSound.currentTime = 0;
            }
        }

        setInterval(saveDataWithSensors, 10000); // Cứ 5 giây lưu 1 dòng mới
    </script>
</body>
</html>